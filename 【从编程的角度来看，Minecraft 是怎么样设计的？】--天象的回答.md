## 从编程的角度来看，Minecraft 是怎么样设计的？

作者: [天象](http://www.zhihu.com/people/liu-rong-34-97)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 赞同: 433


利益相关：minecraft modder<br>“怎么设计的”和“设计成什么样的”是两个不同的问题，“内部的逻辑，一些奇特的机制”都是“设计成什么样的问题。当然这两个问题是紧密相关的。<br>从软件工程的角度，minecraft的代码其实写的不那么漂亮，因为它是一个典型的快速开发不断迭代的项目，看代码就很容易能看出来，minecraft很多部分都明显是先有一个方便的原型， 然后部分重构，再部分重构，这么拖着改到今天这么大的。所以里面有很多不规范、临时的用法在里面残留着。今天我就着重说一说MC写的烂的地方。<i>再顺便黑一黑java</i><br>举几个例子<br>1、GUI<br>MC的GUI是lwjgl从头写的，它写的难看到了什么地步呢，就是随便一个稍微上一点档次的mod，都要重新造一遍轮子。MC GuiScreen里面的一个鼠标事件是这么写的：<br><div class="highlight"><pre><code class="language-java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">mouseClicked</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">enable</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">buttonList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">l</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">GuiButton</span> <span class="n">guibutton</span> <span class="o">=</span> <span class="o">(</span><span class="n">GuiButton</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">buttonList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">l</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">guibutton</span><span class="o">.</span><span class="na">mousePressed</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mc</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">))</span>
                <span class="o">{</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">selectedButton</span> <span class="o">=</span> <span class="n">guibutton</span><span class="o">;</span>
                    <span class="n">guibutton</span><span class="o">.</span><span class="na">playsound</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">mc</span><span class="o">.</span><span class="na">getSoundHandler</span><span class="o">());</span>
                    <span class="k">this</span><span class="o">.</span><span class="na">actionPerformed</span><span class="o">(</span><span class="n">guibutton</span><span class="o">);</span>

                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>GuiButton.mousePressed()长这样：<br><div class="highlight"><pre><code class="language-text">public boolean mousePressed(Minecraft p_146116_1_, int p_146116_2_, int p_146116_3_)
    {
        return this.enabled &amp;&amp; this.visible &amp;&amp; p_146116_2_ &gt;= this.xPosition &amp;&amp; p_146116_3_ &gt;= this.yPosition &amp;&amp; p_146116_2_ &lt; this.xPosition + this.width &amp;&amp; p_146116_3_ &lt; this.yPosition + this.height;
    }
</code></pre></div>对，根本没有事件，也没有回调，逻辑必须在主窗口类的actionPerformed里处理，这是上个世纪90年代的写法。所以说稍微有点档次的mod都要重写GUI，因为MC本来写的真是太难看了。<br>（顺便一提，forge用ASM在这里生插进去了一个事件，虽然这个事件会把别人的按钮事件也发送给你。所以还算有事件可用，但是这就不算MC本身写的了。）<br>2、注册<br>我又回头看了看，注册这个问题很大，所以我决定不止讲那个硬编码的部分，展开说。<br><br>首先就是一段硬编码的注册代码。这是Block类里的：<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerBlocks</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="s">"air"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockAir</span><span class="o">()).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"air"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="s">"stone"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockStone</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">1.5</span><span class="n">F</span><span class="o">).</span><span class="na">setResistance</span><span class="o">(</span><span class="mf">10.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypePiston</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"stone"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"stone"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="s">"grass"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockGrass</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">0.6</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeGrass</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"grass"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"grass"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="s">"dirt"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockDirt</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">0.5</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeGravel</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"dirt"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"dirt"</span><span class="o">));</span>
        <span class="n">Block</span> <span class="n">block</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Block</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">rock</span><span class="o">)).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">2.0</span><span class="n">F</span><span class="o">).</span><span class="na">setResistance</span><span class="o">(</span><span class="mf">10.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypePiston</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"stonebrick"</span><span class="o">).</span><span class="na">setCreativeTab</span><span class="o">(</span><span class="n">CreativeTabs</span><span class="o">.</span><span class="na">tabBlock</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"cobblestone"</span><span class="o">);</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="s">"cobblestone"</span><span class="o">,</span> <span class="n">block</span><span class="o">);</span>
        <span class="n">Block</span> <span class="n">block1</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockWood</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">2.0</span><span class="n">F</span><span class="o">).</span><span class="na">setResistance</span><span class="o">(</span><span class="mf">5.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeWood</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"wood"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"planks"</span><span class="o">);</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s">"planks"</span><span class="o">,</span> <span class="n">block1</span><span class="o">);</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="s">"sapling"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockSapling</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">0.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeGrass</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"sapling"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"sapling"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="s">"bedrock"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">Block</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">rock</span><span class="o">)).</span><span class="na">setBlockUnbreakable</span><span class="o">().</span><span class="na">setResistance</span><span class="o">(</span><span class="mf">6000000.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypePiston</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"bedrock"</span><span class="o">).</span><span class="na">disableStats</span><span class="o">().</span><span class="na">setCreativeTab</span><span class="o">(</span><span class="n">CreativeTabs</span><span class="o">.</span><span class="na">tabBlock</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"bedrock"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="s">"flowing_water"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockDynamicLiquid</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">water</span><span class="o">)).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">100.0</span><span class="n">F</span><span class="o">).</span><span class="na">setLightOpacity</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"water"</span><span class="o">).</span><span class="na">disableStats</span><span class="o">().</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"water_flow"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="s">"water"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockStaticLiquid</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">water</span><span class="o">)).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">100.0</span><span class="n">F</span><span class="o">).</span><span class="na">setLightOpacity</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"water"</span><span class="o">).</span><span class="na">disableStats</span><span class="o">().</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"water_still"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="s">"flowing_lava"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockDynamicLiquid</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">lava</span><span class="o">)).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">100.0</span><span class="n">F</span><span class="o">).</span><span class="na">setLightLevel</span><span class="o">(</span><span class="mf">1.0</span><span class="n">F</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"lava"</span><span class="o">).</span><span class="na">disableStats</span><span class="o">().</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"lava_flow"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="s">"lava"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockStaticLiquid</span><span class="o">(</span><span class="n">Material</span><span class="o">.</span><span class="na">lava</span><span class="o">)).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">100.0</span><span class="n">F</span><span class="o">).</span><span class="na">setLightLevel</span><span class="o">(</span><span class="mf">1.0</span><span class="n">F</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"lava"</span><span class="o">).</span><span class="na">disableStats</span><span class="o">().</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"lava_still"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="s">"sand"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockSand</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">0.5</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeSand</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"sand"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"sand"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">13</span><span class="o">,</span> <span class="s">"gravel"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockGravel</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">0.6</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypeGravel</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"gravel"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"gravel"</span><span class="o">));</span>
        <span class="n">blockRegistry</span><span class="o">.</span><span class="na">addObject</span><span class="o">(</span><span class="mi">14</span><span class="o">,</span> <span class="s">"gold_ore"</span><span class="o">,</span> <span class="o">(</span><span class="k">new</span> <span class="n">BlockOre</span><span class="o">()).</span><span class="na">setHardness</span><span class="o">(</span><span class="mf">3.0</span><span class="n">F</span><span class="o">).</span><span class="na">setResistance</span><span class="o">(</span><span class="mf">5.0</span><span class="n">F</span><span class="o">).</span><span class="na">setStepSound</span><span class="o">(</span><span class="n">soundTypePiston</span><span class="o">).</span><span class="na">setBlockName</span><span class="o">(</span><span class="s">"oreGold"</span><span class="o">).</span><span class="na">setBlockTextureName</span><span class="o">(</span><span class="s">"gold_ore"</span><span class="o">));</span>
</code></pre></div>后面不往下写了，都是这样，直到把所有方块注册完。这是flash小游戏的写法吧。<br>不过硬编码和硬编码也不一样。你应该注意一下细节，blockRegistry.addObject()的第一个参数是一个int，它是方块的序号。在RegistryNamespaced里，这个序号作map的key值。序号硬编码会造成什么恶果呢？对，序号冲突。自己改序号不好改（所以你看到MC从来没有删除过物品或者方块，也没有在中间添加过，因为会导致序号改变），别人加物品更头痛。所以1.6以及之前，mod一直有一个序号冲突的问题。那么在1.7是否解决了序号问题呢？实际上，没有。1.7的方块问题最大的改动是加进了一个UnlocalizedName，意思就是说你以后用这个名字来找方块，但是实际上代码内部还是用int编号硬编码。而1.8最大的改动是让你在游戏内命令里不能按照序号give方块了，而代码内部还是跟上面没什么区别，用int硬编码。<br>于是在1.7，fml加进了自动分配序号的功能：<br><div class="highlight"><pre><code class="language-java"><span class="kn">package</span> <span class="nn">cpw.mods.fml.common.registry</span><span class="o">;</span>

<span class="kd">private</span> <span class="kt">int</span> <span class="nf">registerBlock</span><span class="o">(</span><span class="n">Block</span> <span class="n">block</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">idHint</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="c1">// handle ItemBlock-before-Block registrations</span>
        <span class="n">ItemBlock</span> <span class="n">itemBlock</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">for</span> <span class="o">(</span><span class="n">Item</span> <span class="n">item</span> <span class="o">:</span> <span class="n">iItemRegistry</span><span class="o">.</span><span class="na">typeSafeIterable</span><span class="o">())</span> <span class="c1">// find matching ItemBlock</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">item</span> <span class="k">instanceof</span> <span class="n">ItemBlock</span> <span class="o">&amp;&amp;</span> <span class="o">((</span><span class="n">ItemBlock</span><span class="o">)</span> <span class="n">item</span><span class="o">).</span><span class="na">field_150939_a</span> <span class="o">==</span> <span class="n">block</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">itemBlock</span> <span class="o">=</span> <span class="o">(</span><span class="n">ItemBlock</span><span class="o">)</span> <span class="n">item</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">itemBlock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// has ItemBlock, adjust id and clear the slot already occupied by the corresponding item</span>
        <span class="o">{</span>
            <span class="n">idHint</span> <span class="o">=</span> <span class="n">iItemRegistry</span><span class="o">.</span><span class="na">getId</span><span class="o">(</span><span class="n">itemBlock</span><span class="o">);</span>
            <span class="n">FMLLog</span><span class="o">.</span><span class="na">fine</span><span class="o">(</span><span class="s">"Found matching ItemBlock %s for Block %s at id %d"</span><span class="o">,</span> <span class="n">itemBlock</span><span class="o">,</span> <span class="n">block</span><span class="o">,</span> <span class="n">idHint</span><span class="o">);</span>
            <span class="n">freeSlot</span><span class="o">(</span><span class="n">idHint</span><span class="o">,</span> <span class="n">block</span><span class="o">);</span> <span class="c1">// temporarily free the slot occupied by the Item for the block registration</span>
        <span class="o">}</span>

        <span class="c1">// add</span>
        <span class="kt">int</span> <span class="n">blockId</span> <span class="o">=</span> <span class="n">iBlockRegistry</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">idHint</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">block</span><span class="o">,</span> <span class="n">availabilityMap</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">itemBlock</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="c1">// verify</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">blockId</span> <span class="o">!=</span> <span class="n">idHint</span><span class="o">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Block at itemblock id %d insertion failed, got id %d."</span><span class="o">,</span> <span class="n">idHint</span><span class="o">,</span> <span class="n">blockId</span><span class="o">));</span>
            <span class="n">verifyItemBlockName</span><span class="o">(</span><span class="n">itemBlock</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">useSlot</span><span class="o">(</span><span class="n">blockId</span><span class="o">);</span>
        <span class="o">((</span><span class="n">RegistryDelegate</span><span class="o">.</span><span class="na">Delegate</span><span class="o">&lt;</span><span class="n">Block</span><span class="o">&gt;)</span> <span class="n">block</span><span class="o">.</span><span class="na">delegate</span><span class="o">).</span><span class="na">setName</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">blockId</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div><br>用的namespace都不是原来的RegistryNamespaced，是fml自己的FMLControlledNamespacedRegistry&lt;I&gt;，也就是说原来那个已经没法用了。对，你看fml还加泛型，可以限定这个命名空间给方块用或者给物品用，这就是人的写法。<br>看中间那个if，就是在判断命名空间里有没有；如果没有，重新分配序号。<br>这个就是有fml，帮我们解决了MC的代码问题。如果fml没解决呢？<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Potion</span>
<span class="o">{</span>
    <span class="cm">/** The array of potion types. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span><span class="o">[]</span> <span class="n">potionTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Potion</span><span class="o">[</span><span class="mi">32</span><span class="o">];</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76423_b</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">moveSpeed</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">8171462</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.moveSpeed"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">func_111184_a</span><span class="o">(</span><span class="n">SharedMonsterAttributes</span><span class="o">.</span><span class="na">movementSpeed</span><span class="o">,</span> <span class="s">"91AEAA56-376B-4498-935B-2F7F68070635"</span><span class="o">,</span> <span class="mf">0.20000000298023224</span><span class="n">D</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">moveSlowdown</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">5926017</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.moveSlowdown"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">func_111184_a</span><span class="o">(</span><span class="n">SharedMonsterAttributes</span><span class="o">.</span><span class="na">movementSpeed</span><span class="o">,</span> <span class="s">"7107DE5E-7CE8-4030-940E-514C1F160890"</span><span class="o">,</span> <span class="o">-</span><span class="mf">0.15000000596046448</span><span class="n">D</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">digSpeed</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">14270531</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.digSpeed"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">1.5</span><span class="n">D</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">digSlowdown</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">4866583</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.digSlowDown"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">damageBoost</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionAttackDamage</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">9643043</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.damageBoost"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">func_111184_a</span><span class="o">(</span><span class="n">SharedMonsterAttributes</span><span class="o">.</span><span class="na">attackDamage</span><span class="o">,</span> <span class="s">"648D7064-6A60-4F59-8ABE-C2C23A6DD7A9"</span><span class="o">,</span> <span class="mf">3.0</span><span class="n">D</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">heal</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionHealth</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">16262179</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.heal"</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">harm</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionHealth</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">4393481</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.harm"</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">jump</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">8</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">7889559</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.jump"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">confusion</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">9</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">5578058</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.confusion"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">0.25</span><span class="n">D</span><span class="o">);</span>
    <span class="cm">/** The regeneration Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">regeneration</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">13458603</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.regeneration"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">0.25</span><span class="n">D</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">resistance</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">10044730</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.resistance"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** The fire resistance Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">fireResistance</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">14981690</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.fireResistance"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** The water breathing Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">waterBreathing</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">13</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">3035801</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.waterBreathing"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** The invisibility Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">invisibility</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">14</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">8356754</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.invisibility"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** The blindness Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">blindness</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">2039587</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.blindness"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">0.25</span><span class="n">D</span><span class="o">);</span>
    <span class="cm">/** The night vision Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">nightVision</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">16</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2039713</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.nightVision"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** The hunger Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">hunger</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">17</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">5797459</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.hunger"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** The weakness Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">weakness</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionAttackDamage</span><span class="o">(</span><span class="mi">18</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">4738376</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.weakness"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">func_111184_a</span><span class="o">(</span><span class="n">SharedMonsterAttributes</span><span class="o">.</span><span class="na">attackDamage</span><span class="o">,</span> <span class="s">"22653B89-116E-49DC-9B6B-9971489B5BE5"</span><span class="o">,</span> <span class="mf">2.0</span><span class="n">D</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="cm">/** The poison Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">poison</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">5149489</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.poison"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">0.25</span><span class="n">D</span><span class="o">);</span>
    <span class="cm">/** The wither Potion object. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">wither</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">Potion</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">3484199</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.wither"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">setEffectiveness</span><span class="o">(</span><span class="mf">0.25</span><span class="n">D</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76434_w</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionHealthBoost</span><span class="o">(</span><span class="mi">21</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">16284963</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.healthBoost"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="na">func_111184_a</span><span class="o">(</span><span class="n">SharedMonsterAttributes</span><span class="o">.</span><span class="na">maxHealth</span><span class="o">,</span> <span class="s">"5D6F0BA2-1186-46AC-B896-C61C5CEE99CC"</span><span class="o">,</span> <span class="mf">4.0</span><span class="n">D</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76444_x</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionAbsoption</span><span class="o">(</span><span class="mi">22</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">2445989</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.absorption"</span><span class="o">).</span><span class="na">setIconIndex</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76443_y</span> <span class="o">=</span> <span class="o">(</span><span class="k">new</span> <span class="n">PotionHealth</span><span class="o">(</span><span class="mi">23</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">16262179</span><span class="o">)).</span><span class="na">setPotionName</span><span class="o">(</span><span class="s">"potion.saturation"</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76442_z</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76409_A</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76410_B</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76411_C</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76405_D</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76406_E</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76407_F</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span> <span class="n">field_76408_G</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</code></pre></div>没错，这就是药水类的注册。也不用什么register了，直接写static了。<br>好吧，你是怎么写的我也不想管了，我就想加几种自己定义的药水效果。然后我们就看到了一行代码：<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Potion</span><span class="o">[]</span> <span class="n">potionTypes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Potion</span><span class="o">[</span><span class="mi">32</span><span class="o">];</span>
</code></pre></div>尼玛。数组，而且还是定长数组。<br>怎么办？老实说，没什么好办法，因为fml没帮你解决这个问题。固然你可以换掉这个数组给它扩容，但是这必然会导致mod和mod不兼容。反正，现在版本依然有大量的药水效果冲突的问题存在。比如你可以在1.7.10装个IC再装个环境，看饥渴效果是怎么变成辐射效果把你秒了的。TC的药水数量已经自己都在那几个空里装不下了，他自己实现了一个potion数组，但是他不是fml，我们也没法都转移过去，所以这个问题也没什么好办法。<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Enchantment</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span><span class="o">[]</span> <span class="n">enchantmentsList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Enchantment</span><span class="o">[</span><span class="mi">256</span><span class="o">];</span>
    <span class="cm">/** The list of enchantments applicable by the anvil from a book */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span><span class="o">[]</span> <span class="n">enchantmentsBookList</span><span class="o">;</span>
    <span class="cm">/** Converts environmental damage to armour damage */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">protection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentProtection</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="cm">/** Protection against fire */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">fireProtection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentProtection</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** Less fall damage */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">featherFalling</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentProtection</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** Protection against explosions */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">blastProtection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentProtection</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
    <span class="cm">/** Protection against projectile entities (e.g. arrows) */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">projectileProtection</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentProtection</span><span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span>
    <span class="cm">/** Decreases the rate of air loss underwater; increases time between damage while suffocating */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">respiration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentOxygen</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** Increases underwater mining rate */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">aquaAffinity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentWaterWorker</span><span class="o">(</span><span class="mi">6</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">thorns</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentThorns</span><span class="o">(</span><span class="mi">7</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** Extra damage to mobs */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">sharpness</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentDamage</span><span class="o">(</span><span class="mi">16</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="cm">/** Extra damage to zombies, zombie pigmen and skeletons */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">smite</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentDamage</span><span class="o">(</span><span class="mi">17</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** Extra damage to spiders, cave spiders and silverfish */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">baneOfArthropods</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentDamage</span><span class="o">(</span><span class="mi">18</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** Knocks mob and players backwards upon hit */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">knockback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentKnockback</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
    <span class="cm">/** Lights mobs on fire */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">fireAspect</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentFireAspect</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** Mobs have a chance to drop more loot */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">looting</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentLootBonus</span><span class="o">(</span><span class="mi">21</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">EnumEnchantmentType</span><span class="o">.</span><span class="na">weapon</span><span class="o">);</span>
    <span class="cm">/** Faster resource gathering while in use */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">efficiency</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentDigging</span><span class="o">(</span><span class="mi">32</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
    <span class="cm">/**</span>
<span class="cm">     * Blocks mined will drop themselves, even if it should drop something else (e.g. stone will drop stone, not</span>
<span class="cm">     * cobblestone)</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">silkTouch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentUntouching</span><span class="o">(</span><span class="mi">33</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="cm">/** Sometimes, the tool's durability will not be spent when the tool is used */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">unbreaking</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentDurability</span><span class="o">(</span><span class="mi">34</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
    <span class="cm">/** Can multiply the drop rate of items from blocks */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">fortune</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentLootBonus</span><span class="o">(</span><span class="mi">35</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">EnumEnchantmentType</span><span class="o">.</span><span class="na">digger</span><span class="o">);</span>
    <span class="cm">/** Power enchantment for bows, add's extra damage to arrows. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">power</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentArrowDamage</span><span class="o">(</span><span class="mi">48</span><span class="o">,</span> <span class="mi">10</span><span class="o">);</span>
    <span class="cm">/** Knockback enchantments for bows, the arrows will knockback the target when hit. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">punch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentArrowKnockback</span><span class="o">(</span><span class="mi">49</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/** Flame enchantment for bows. Arrows fired by the bow will be on fire. Any target hit will also set on fire. */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">flame</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentArrowFire</span><span class="o">(</span><span class="mi">50</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
    <span class="cm">/**</span>
<span class="cm">     * Infinity enchantment for bows. The bow will not consume arrows anymore, but will still required at least one</span>
<span class="cm">     * arrow on inventory use the bow.</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">infinity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentArrowInfinite</span><span class="o">(</span><span class="mi">51</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">field_151370_z</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentLootBonus</span><span class="o">(</span><span class="mi">61</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">EnumEnchantmentType</span><span class="o">.</span><span class="na">fishing_rod</span><span class="o">);</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Enchantment</span> <span class="n">field_151369_A</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EnchantmentFishingSpeed</span><span class="o">(</span><span class="mi">62</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">EnumEnchantmentType</span><span class="o">.</span><span class="na">fishing_rod</span><span class="o">);</span>
</code></pre></div>附魔的问题好一些，好在什么地方呢？他的数组长。有时候想想挺可笑的，写mod遇到这么大麻烦，就是因为mojang有个数写的不够大。<br><br>3、性能<br>性能这一块我要分两部分，先黑java，再黑mojang。<br>没错，java性能就是差，你来打我啊。<br><br><br><br><br><br><br>打完了没有，我要回家了。<br>好吧，让我们认真来说，java性能就是差。当然mc也跟所有的java程序一样，里面充满了new new new new，耗内存比耗CPU还多，这么个小游戏居然没个2G内存带不起来。画图性能也不咋地，当然最新的lwjgl3.0有了一定的好转，不过稍早的mc用的还是2.4，简直惨，就这么个根本没有几个多边形的游戏，看着不同的地方能差十几帧。<br>算法倒没什么可黑的，mc主要吃CPU的算法都写的中规中矩<i>网上抄的</i>，按照java规范来，快不到哪去但也没法写的再快了。比如PathNavigate和WorldGen系列，算法比较复杂，详细的就不贴了。<br>好，黑java差不多，该黑mojang了。先给你们看看1.8特性列表里的一栏。<br><blockquote>渲染 &amp; 图像优化<ul><li>显著的提高 FPS 和性能</li><li>每个世界(主世界、下界、末路之地) 现在各自独立运作</li><li>区块渲染和区块重建现在使用多线程- 超快速的区块渲染！</li><li>重写了区块序列</li><li>Better visibility culling code</li><li>生物寻路现在是多线程的</li><li>重写储物系统</li><li>矿物生成现在较以前快了2倍</li><li>现在只有透明方块才可以被渲染为透明的(移除X光材质包的使用)</li><li>Dropped items now face the player in all three directions on fast graphics</li><li>重写方块是如何被渲染的</li><li>重写方块数据是如何被处理的</li><li>改善游戏并使"cooler things" 得以被实现</li></ul></blockquote>也就是说，直到1.8之前，区块重建、矿物生成、多世界、生物寻路都是<b>单线程</b>的。你要知道，这些可都是性能大头，这些部分是单线程的，意味着mc服务器基本上就是单线程的……<br><img src="http://pic3.zhimg.com/12e16b4c7c2e311a3ef27fd38cdf141a_b.jpg" data-rawwidth="50" data-rawheight="50" class="content_image" width="50">坑爹啊！<br>还是给你们看一看mc的线程状况吧。以下以1.7.10版本为准。<br>怎么知道mc哪里有线程呢？搜索Thread和synchronized关键字。<br><img src="http://pic4.zhimg.com/a1a73f268fde0c6800e80b26cbe6e6a7_b.jpg" data-rawwidth="657" data-rawheight="740" class="origin_image zh-lightbox-thumb" width="657" data-original="http://pic4.zhimg.com/a1a73f268fde0c6800e80b26cbe6e6a7_r.jpg">好嘛，有OpenGL用的，有OpenAL用的，有twitch流用的，有Crash的时候打印错误信息用的，有网关IO用的，就是没有算法用的……<br>再看看synchronized<br><img src="http://pic4.zhimg.com/1befcbeb36d9ad5a576c4589ac2d77b3_b.jpg" data-rawwidth="358" data-rawheight="783" class="content_image" width="358">跟上面差不多，有文件IO的，有网络IO的，有图像IO的，有视频IO的……<br>不过world类里那两个是真的，Chunk和Gen确实有多线程，这个等黑完了我再夸一夸。<br>好吧，有没有可能我们漏掉了什么地方，实际上mc多数代码早已悄悄躲进几个大线程里，普通代码根本不用加锁呢？我们来调试一下看看：<br><img src="http://pic3.zhimg.com/2daa807d8b5f222f61e59cb3955a73ea_b.jpg" data-rawwidth="496" data-rawheight="447" class="origin_image zh-lightbox-thumb" width="496" data-original="http://pic3.zhimg.com/2daa807d8b5f222f61e59cb3955a73ea_r.jpg">什么乱七八糟线程都有，就是看不见算法分线程。实际上MC代码就全都运行在就那一个高亮的Server Thread里面。<br>1.8进步了，不过有限。如果照样搜一遍的话，我们会看到ChunkRender里有了Thread和synchronized，对应上面的方块渲染。<br>珍爱服务器，远离1.7。希望微软赶紧用C++把mc重写。<i>然后把学不会C++的都赶走，这样我就是领军人物了。如果能招我进微软就更好了。</i><br>4、API<br>现在想了想，API的问题应该放到第一去讲的。但是实际上上面三个都是我们modder的眼中钉肉中刺，相比之下API的问题都已经习惯了，所以我现在才想起来这个问题。<br>那么我们就讲讲mc里的API怎么写的。<br>问：MC里的API怎么写的？<br>答：MC根本没有API。<br><br><img src="http://pic3.zhimg.com/12e16b4c7c2e311a3ef27fd38cdf141a_b.jpg" data-rawwidth="50" data-rawheight="50" class="content_image" width="50">我们刚刚提过，MC是从一个小游戏慢慢变大的，所以里面有很多历史遗留写法。细节上的历史遗留讲的很多了，那么架构上最大的遗留问题是什么呢？那就是API。<br>MC的架构，根本没有给写API留下什么空间。<br>仍以一个方块为例，MC里采用一种类似享元模式的设计模式处理方块，每一种方块都是一个对象。为了创造具有特殊行为的方块，需要写一个新类继承Block类，并且Override相应的函数以实现自己的行为。那么，Block类大概有多大呢？<br>2631行，大概200个可以被重载的函数，其中大部分都在某个方块类里被重载了。<br>举个特定方块类的例子，比如矿物方块。<br><div class="highlight"><pre><code class="language-text">public class BlockOre extends Block
{
    public BlockOre()
    {
        super(Material.rock);
        this.setCreativeTab(CreativeTabs.tabBlock);
    }

    public Item getItemDropped(int p_149650_1_, Random p_149650_2_, int p_149650_3_)
    {
        return this == Blocks.coal_ore ? Items.coal : (this == Blocks.diamond_ore ? Items.diamond : (this == Blocks.lapis_ore ? Items.dye : (this == Blocks.emerald_ore ? Items.emerald : (this == Blocks.quartz_ore ? Items.quartz : Item.getItemFromBlock(this)))));
    }

    public int quantityDropped(Random p_149745_1_)
    {
        return this == Blocks.lapis_ore ? 4 + p_149745_1_.nextInt(5) : 1;
    }

    public int quantityDroppedWithBonus(int p_149679_1_, Random p_149679_2_)
    {
        if (p_149679_1_ &gt; 0 &amp;&amp; Item.getItemFromBlock(this) != this.getItemDropped(0, p_149679_2_, p_149679_1_))
        {
            int j = p_149679_2_.nextInt(p_149679_1_ + 2) - 1;

            if (j &lt; 0)
            {
                j = 0;
            }

            return this.quantityDropped(p_149679_2_) * (j + 1);
        }
        else
        {
            return this.quantityDropped(p_149679_2_);
        }
    }

    public void dropBlockAsItemWithChance(World p_149690_1_, int p_149690_2_, int p_149690_3_, int p_149690_4_, int p_149690_5_, float p_149690_6_, int p_149690_7_)
    {
        super.dropBlockAsItemWithChance(p_149690_1_, p_149690_2_, p_149690_3_, p_149690_4_, p_149690_5_, p_149690_6_, p_149690_7_);
    }

    private Random rand = new Random();
    @Override
    public int getExpDrop(IBlockAccess p_149690_1_, int p_149690_5_, int p_149690_7_)
    {
        if (this.getItemDropped(p_149690_5_, rand, p_149690_7_) != Item.getItemFromBlock(this))
        {
            int j1 = 0;

            if (this == Blocks.coal_ore)
            {
                j1 = MathHelper.getRandomIntegerInRange(rand, 0, 2);
            }
            else if (this == Blocks.diamond_ore)
            {
                j1 = MathHelper.getRandomIntegerInRange(rand, 3, 7);
            }
            else if (this == Blocks.emerald_ore)
            {
                j1 = MathHelper.getRandomIntegerInRange(rand, 3, 7);
            }
            else if (this == Blocks.lapis_ore)
            {
                j1 = MathHelper.getRandomIntegerInRange(rand, 2, 5);
            }
            else if (this == Blocks.quartz_ore)
            {
                j1 = MathHelper.getRandomIntegerInRange(rand, 2, 5);
            }

            return j1;
        }
        return 0;
    }

    public int damageDropped(int p_149692_1_)
    {
        return this == Blocks.lapis_ore ? 4 : 0;
    }
}
</code></pre></div>看，新方块类就这么写，继承一下Block，然后就开始胡改了。不管是被按照Block调用还是调用别的函数，都没有中间层抽象，都是直接调用。耦合成这个样子，怎么写API？无怪mojang 1.6的时候就说要写API了，都这么久了还一点消息没有，这怎么能写出来API。<br>现在所有的modder写mod，都必须拿着反编译反混淆过的源码，大量地直接使用MC里原有的基类和调用函数，把自己的代码完全嵌入MC的架构里，否则没法写。<br>反编译是否违法呢？当然违法，人家可是商业软件。但是有什么办法，我还想有成熟的API可用呢，mojang自己不争气写不出来API，又不敢关门撵人，所以就变成了现在这个样子，mojang默许整个MC社区使用MC的反编译代码（这个工程叫MCP）来写mod。所以说mod社区对微软收购这件事这么敏感，因为本来就名不正言不顺。<br>如果MC有了API，大概会是什么样子呢？虽然目前还没有可以整个用来写mod的API，不过一个子集已经有了，叫bukkit。bukkit很能说明一个有了API的开发，是一种什么感受。bukkit大概总共就这么长：<br><div class="highlight"><pre><code class="language-java"><span class="n">org</span><span class="o">.</span><span class="na">bukkit</span>	
<span class="n">More</span> <span class="n">generalized</span> <span class="n">classes</span> <span class="n">in</span> <span class="n">the</span> <span class="n">API</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">block</span>	
<span class="n">Classes</span> <span class="n">used</span> <span class="n">to</span> <span class="n">manipulate</span> <span class="n">the</span> <span class="n">voxels</span> <span class="n">in</span> <span class="n">a</span> <span class="n">world</span><span class="o">,</span> <span class="n">including</span> <span class="n">special</span> <span class="n">states</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">block</span><span class="o">.</span><span class="na">banner</span>	 
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">command</span>	
<span class="n">Classes</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">handling</span> <span class="n">specialized</span> <span class="n">non</span><span class="o">-</span><span class="n">chat</span> <span class="n">player</span> <span class="n">input</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">command</span><span class="o">.</span><span class="na">defaults</span>	
<span class="n">Commands</span> <span class="k">for</span> <span class="n">emulating</span> <span class="n">the</span> <span class="n">Minecraft</span> <span class="n">commands</span> <span class="n">and</span> <span class="n">other</span> <span class="n">necessary</span> <span class="n">ones</span> <span class="k">for</span> <span class="n">use</span> <span class="n">by</span> <span class="n">a</span> <span class="n">Bukkit</span> <span class="n">implementation</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">configuration</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">handling</span> <span class="n">a</span> <span class="n">plugin</span><span class="err">'</span><span class="n">s</span> <span class="n">runtime</span> <span class="n">configuration</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">file</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">facilitating</span> <span class="n">configurations</span> <span class="n">to</span> <span class="n">be</span> <span class="n">read</span> <span class="n">and</span> <span class="n">stored</span> <span class="n">on</span> <span class="n">the</span> <span class="n">filesystem</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">configuration</span><span class="o">.</span><span class="na">serialization</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">being</span> <span class="n">able</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">serialization</span> <span class="n">specialized</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Bukkit</span> <span class="n">configuration</span> <span class="n">implementation</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">conversations</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">direct</span> <span class="n">player</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">plugin</span> <span class="n">communication</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">enchantments</span>	
<span class="n">Classes</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">the</span> <span class="n">specialized</span> <span class="n">enhancements</span> <span class="n">to</span> <span class="n">item</span> <span class="n">stacks</span><span class="o">,</span> <span class="n">as</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span> <span class="n">meta</span> <span class="n">data</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">entity</span>	
<span class="n">Interfaces</span> <span class="k">for</span> <span class="n">non</span><span class="o">-</span><span class="n">voxel</span> <span class="n">objects</span> <span class="n">that</span> <span class="n">can</span> <span class="n">exist</span> <span class="n">in</span> <span class="n">a</span> <span class="n">world</span><span class="o">,</span> <span class="n">including</span> <span class="n">all</span> <span class="n">players</span><span class="o">,</span> <span class="n">monsters</span><span class="o">,</span> <span class="n">projectiles</span><span class="o">,</span> <span class="n">etc</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">entity</span><span class="o">.</span><span class="na">minecart</span>	
<span class="n">Interfaces</span> <span class="k">for</span> <span class="n">various</span> <span class="n">Minecart</span> <span class="n">types</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">handling</span> <span class="n">triggered</span> <span class="n">code</span> <span class="n">executions</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">block</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">when</span> <span class="n">a</span> <span class="n">block</span> <span class="n">is</span> <span class="n">changed</span> <span class="n">or</span> <span class="n">interacts</span> <span class="n">with</span> <span class="n">the</span> <span class="n">world</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">enchantment</span>	
<span class="n">Events</span> <span class="n">triggered</span> <span class="n">from</span> <span class="n">an</span> <span class="n">enchantment</span> <span class="n">table</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">entity</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">entities</span><span class="o">,</span> <span class="n">excluding</span> <span class="n">some</span> <span class="n">directly</span> <span class="n">referencing</span> <span class="n">some</span> <span class="n">more</span> <span class="n">specific</span> <span class="n">entity</span> <span class="n">types</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">hanging</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">entities</span> <span class="n">that</span> <span class="n">hang</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">inventory</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">inventory</span> <span class="n">manipulation</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">painting</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">paintings</span><span class="o">,</span> <span class="n">but</span> <span class="n">deprecated</span> <span class="k">for</span> <span class="n">more</span> <span class="n">general</span> <span class="n">hanging</span> <span class="n">events</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">player</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">players</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">server</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">programmatic</span> <span class="n">state</span> <span class="n">changes</span> <span class="n">on</span> <span class="n">the</span> <span class="n">server</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">vehicle</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">vehicular</span> <span class="n">entities</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">weather</span>	
<span class="n">Events</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">weather</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">event</span><span class="o">.</span><span class="na">world</span>	
<span class="n">Events</span> <span class="n">triggered</span> <span class="n">by</span> <span class="n">various</span> <span class="n">world</span> <span class="n">states</span> <span class="n">or</span> <span class="n">changes</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">generator</span>	
<span class="n">Classes</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">world</span> <span class="n">generation</span> <span class="n">implementation</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">help</span>	
<span class="n">Classes</span> <span class="n">used</span> <span class="n">to</span> <span class="n">manipulate</span> <span class="n">the</span> <span class="k">default</span> <span class="n">command</span> <span class="n">and</span> <span class="n">topic</span> <span class="n">assistance</span> <span class="n">system</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">inventory</span>	
<span class="n">Classes</span> <span class="n">involved</span> <span class="n">in</span> <span class="n">manipulating</span> <span class="n">player</span> <span class="n">inventories</span> <span class="n">and</span> <span class="n">item</span> <span class="n">interactions</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">inventory</span><span class="o">.</span><span class="na">meta</span>	
<span class="n">The</span> <span class="n">interfaces</span> <span class="n">used</span> <span class="n">when</span> <span class="n">manipulating</span> <span class="n">extra</span> <span class="n">data</span> <span class="n">can</span> <span class="n">can</span> <span class="n">be</span> <span class="n">stored</span> <span class="n">inside</span> <span class="n">item</span> <span class="n">stacks</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">map</span>	
<span class="n">Classes</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">plugin</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">map</span> <span class="n">displays</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">material</span>	
<span class="n">Classes</span> <span class="n">that</span> <span class="n">represents</span> <span class="n">various</span> <span class="n">voxel</span> <span class="n">types</span> <span class="n">and</span> <span class="n">states</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">metadata</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">providing</span> <span class="n">a</span> <span class="n">layer</span> <span class="n">of</span> <span class="n">plugin</span> <span class="n">specified</span> <span class="n">data</span> <span class="n">on</span> <span class="n">various</span> <span class="n">Minecraft</span> <span class="n">concepts</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">permissions</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">providing</span> <span class="n">binary</span> <span class="n">state</span> <span class="n">properties</span> <span class="n">to</span> <span class="n">players</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">plugin</span>	
<span class="n">Classes</span> <span class="n">specifically</span> <span class="n">relating</span> <span class="n">to</span> <span class="n">loading</span> <span class="n">software</span> <span class="n">modules</span> <span class="n">at</span> <span class="n">runtime</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">plugin</span><span class="o">.</span><span class="na">java</span>	
<span class="n">Classes</span> <span class="k">for</span> <span class="n">handling</span> <span class="n">plugins</span> <span class="n">written</span> <span class="n">in</span> <span class="n">java</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">plugin</span><span class="o">.</span><span class="na">messaging</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">specialized</span> <span class="n">plugin</span> <span class="n">to</span> <span class="n">client</span> <span class="n">protocols</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">potion</span>	
<span class="n">Classes</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">various</span> <span class="n">potion</span> <span class="n">properties</span> <span class="n">and</span> <span class="n">manipulation</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">projectiles</span>	
<span class="n">Classes</span> <span class="n">to</span> <span class="n">represent</span> <span class="n">the</span> <span class="n">source</span> <span class="n">of</span> <span class="n">a</span> <span class="n">projectile</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">scheduler</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">letting</span> <span class="n">plugins</span> <span class="n">run</span> <span class="n">code</span> <span class="n">at</span> <span class="n">specific</span> <span class="n">time</span> <span class="n">intervals</span><span class="o">,</span> <span class="n">including</span> <span class="n">thread</span> <span class="n">safety</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">scoreboard</span>	
<span class="n">Interfaces</span> <span class="n">used</span> <span class="n">to</span> <span class="n">manage</span> <span class="n">the</span> <span class="n">client</span> <span class="n">side</span> <span class="n">score</span> <span class="n">display</span> <span class="n">system</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">util</span>	
<span class="n">Multi</span> <span class="n">and</span> <span class="n">single</span> <span class="n">purpose</span> <span class="n">classes</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">various</span> <span class="n">programmatic</span> <span class="n">concepts</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">io</span>	
<span class="n">Classes</span> <span class="n">used</span> <span class="n">to</span> <span class="n">facilitate</span> <span class="n">stream</span> <span class="n">processing</span> <span class="k">for</span> <span class="n">specific</span> <span class="n">Bukkit</span> <span class="n">concepts</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">noise</span>	
<span class="n">Classes</span> <span class="n">dedicated</span> <span class="n">to</span> <span class="n">facilitating</span> <span class="n">deterministic</span> <span class="n">noise</span><span class="o">.</span>
<span class="n">org</span><span class="o">.</span><span class="na">bukkit</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">permissions</span>	
<span class="n">Static</span> <span class="n">methods</span> <span class="k">for</span> <span class="n">miscellaneous</span> <span class="n">permission</span> <span class="n">functionality</span><span class="o">.</span>
</code></pre></div>相比之下MC包的数量大概是他的三倍，类的数量……我不想算了，因为每个物品\方块都是类。<br>你要知道，这些部分全都是解耦的。bukkit这些接口是真正的接口，bukkit并不会规定其具体实现，每一版craftbukkit都会有所不同。而且bukkit向下兼容，其内容简洁易懂，符合软件工程原则，使用舒适度远超读MC那些诘屈聱牙的大段代码。这就是一个真正的API该有的样子。<br>forge是不是API呢？实际上，不是。在写mod的时候，只有两个部分要跟forge交互：<br>1.forge.event。原版MC是没有事件系统的，这个样子连调用自己的代码都办不到。forge加进了一些事件，包括MC初始化事件，让你有机会处理事务。<br>2.register。这基本上是一些便利类，能简化你注册方块、物品、翻译文件一类的流程，可以写一个函数搞定。<br>这些不是API，实际上它们没有抽象任何事情，你真正需要解决的问题还是得到源码里搞定，他只是帮你解决不该由你解决的问题而已。<br><br>5、网络<br>相信眼尖的同学在线程里已经看见了，MC的网络连接用的是netty。netty设计的大致还是没什么问题的，有问题这里也不提了。我们就看看netty IO的上下游，MC发包和解包怎么写的。<br>先看一下类，有Packet类，每种Packet有个类，有INetHandler，有NetHandler，写的挺好嘛，一个一个看。<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Packet</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Packet</span> <span class="nf">generatePacket</span><span class="o">(</span><span class="n">BiMap</span> <span class="n">p_148839_0_</span><span class="o">,</span> <span class="kt">int</span> <span class="n">p_148839_1_</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">try</span>
        <span class="o">{</span>
            <span class="n">Class</span> <span class="n">oclass</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">)</span><span class="n">p_148839_0_</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">p_148839_1_</span><span class="o">));</span>
            <span class="k">return</span> <span class="n">oclass</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="o">(</span><span class="n">Packet</span><span class="o">)</span><span class="n">oclass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">exception</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Couldn\'t create packet "</span> <span class="o">+</span> <span class="n">p_148839_1_</span><span class="o">,</span> <span class="n">exception</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">readPacketData</span><span class="o">(</span><span class="n">PacketBuffer</span> <span class="n">p_148837_1_</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">writePacketData</span><span class="o">(</span><span class="n">PacketBuffer</span> <span class="n">p_148840_1_</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">processPacket</span><span class="o">(</span><span class="n">INetHandler</span> <span class="n">p_148833_1_</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>不错，有抽象基类，还自带一个小工厂。找个类看看。<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">C09PacketHeldItemChange</span> <span class="kd">extends</span> <span class="n">Packet</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="nf">C09PacketHeldItemChange</span><span class="o">(</span><span class="kt">int</span> <span class="n">slot</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">hold</span> <span class="o">=</span> <span class="n">slot</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readPacketData</span><span class="o">(</span><span class="n">PacketBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bit</span><span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">readShort</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writePacketData</span><span class="o">(</span><span class="n">PacketBuffer</span> <span class="n">buffer</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="n">buffer</span><span class="o">.</span><span class="na">writeShort</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">bit</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processPacket</span><span class="o">(</span><span class="n">INetHandlerPlayServer</span> <span class="n">nethandler</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">nethandler</span><span class="o">.</span><span class="na">processHeldItemChange</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processPacket</span><span class="o">(</span><span class="n">INetHandler</span> <span class="n">nethandler</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">processPacket</span><span class="o">((</span><span class="n">INetHandlerPlayServer</span><span class="o">)</span><span class="n">nethandler</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>……等等，解包之后的实现哪去了？<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetworkManager</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span>    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processReceivedPackets</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">netHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span> <span class="o">!</span><span class="k">this</span><span class="o">.</span><span class="na">receivedPacketsQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="n">i</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">Packet</span> <span class="n">packet</span> <span class="o">=</span> <span class="o">(</span><span class="n">Packet</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">receivedPacketsQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                <span class="n">packet</span><span class="o">.</span><span class="na">processPacket</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">netHandler</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="k">this</span><span class="o">.</span><span class="na">netHandler</span><span class="o">.</span><span class="na">onNetworkTick</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">channel</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div>这……<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">NetHandlerPlayServer</span> <span class="kd">implements</span> <span class="n">INetHandlerPlayServer</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processAnimation</span><span class="o">(</span><span class="n">C0APacketAnimation</span> <span class="n">p_147350_1_</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">func_143004_u</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">p_147350_1_</span><span class="o">.</span><span class="na">func_149421_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">swingItem</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processEntityAction</span><span class="o">(</span><span class="n">C0BPacketEntityAction</span> <span class="n">p_147357_1_</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">func_143004_u</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">setSneaking</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">setSneaking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">setSprinting</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">5</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">setSprinting</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">3</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">wakeUpPlayer</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">hasMoved</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">6</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span> <span class="k">instanceof</span> <span class="n">EntityHorse</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="o">((</span><span class="n">EntityHorse</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span><span class="o">).</span><span class="na">setJumpPower</span><span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149512_e</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">p_147357_1_</span><span class="o">.</span><span class="na">func_149513_d</span><span class="o">()</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span> <span class="k">instanceof</span> <span class="n">EntityHorse</span><span class="o">)</span>
        <span class="o">{</span>
            <span class="o">((</span><span class="n">EntityHorse</span><span class="o">)</span><span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">ridingEntity</span><span class="o">).</span><span class="na">openGUI</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processHeldItemChange</span><span class="o">(</span><span class="n">C09PacketHeldItemChange</span> <span class="n">p_147355_1_</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">p_147355_1_</span><span class="o">.</span><span class="na">func_149614_c</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">p_147355_1_</span><span class="o">.</span><span class="na">func_149614_c</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">InventoryPlayer</span><span class="o">.</span><span class="na">getHotbarSize</span><span class="o">())</span>
        <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">inventory</span><span class="o">.</span><span class="na">currentItem</span> <span class="o">=</span> <span class="n">p_147355_1_</span><span class="o">.</span><span class="na">func_149614_c</span><span class="o">();</span>
            <span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">func_143004_u</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">else</span>
        <span class="o">{</span>
            <span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">playerEntity</span><span class="o">.</span><span class="na">getCommandSenderName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" tried to set an invalid carried item"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">(...)</span>

<span class="o">}</span>
</code></pre></div>……尼玛。<br>这解包的具体实现是写在Handler类里的，把每个被Handle的类的实现都写在Handler里<br> ，比硬编码还硬编码。注册那些硬编码至少还是数据，只是难看点，不妨碍你继续往数组里加数据；这硬编码的是函数，根本不可能加。<br>于是我们很奇怪，接口呢？我们不是还有一个接口，可以用来实现具体解包过程吗？<br><div class="highlight"><pre><code class="language-java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">INetHandlerPlayServer</span> <span class="kd">extends</span> <span class="n">INetHandler</span>
<span class="o">{</span>
    <span class="kt">void</span> <span class="nf">processAnimation</span><span class="o">(</span><span class="n">C0APacketAnimation</span> <span class="n">p_147350_1_</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">processChatMessage</span><span class="o">(</span><span class="n">C01PacketChatMessage</span> <span class="n">p_147354_1_</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">processPlayerDigging</span><span class="o">(</span><span class="n">C07PacketPlayerDigging</span> <span class="n">p_147345_1_</span><span class="o">);</span>

    <span class="kt">void</span> <span class="nf">processHeldItemChange</span><span class="o">(</span><span class="n">C09PacketHeldItemChange</span> <span class="n">p_147355_1_</span><span class="o">);</span>

<span class="o">(...)</span>

<span class="o">}</span>
</code></pre></div>让我笑一会，哈哈哈哈哈哈哈。<br>正常人写接口会有很多子类，然后在接口里定义一组对应同一个抽象概念的函数。这个接口只有一个子类，然后在接口里定义一堆互相平行的具体实现。这个接口存在的意义是什么。<br>MC的网络的抽象层烂到这个地步，已经完全没法复用了。幸好，天无绝人之路，netty的抽象层够多，可以给我们其他的解决方案。<br><img src="http://pic2.zhimg.com/05c6ec4e136ec3993126fbd105739f65_b.jpg" data-rawwidth="450" data-rawheight="536" class="origin_image zh-lightbox-thumb" width="450" data-original="http://pic2.zhimg.com/05c6ec4e136ec3993126fbd105739f65_r.jpg"><br>这是netty的管道图，可以非常直观地看出，在一个Channel内部，还可以定义许多个Handler进行处理。MC只用了他自己的几个Handler，我们可以再定义自己的Handler处理packet。实际上，大型mod多半这么处理的。FML也给了相应的注册类和API，首先提供了FMLEventChannel来直达netty层，适合熟练使用netty的用户；对于需求简单、不会netty的用户（比如我）还封装了一个SimpleNetworkWrapper，提供了简单的直接IO。和MC一比，FML写的真是好，各个抽象层都考虑到，而且都对齐。谁叫MC已经烂到一定程度了呢。<br><br>想吐的槽都吐差不多了，再写点总结补充就结束了吧。



编辑于 2015-04-03



---
原问链接: [http://www.zhihu.com/question/24459078](http://www.zhihu.com/question/24459078)